#!/bin/bash

## #ddev-generated
## Description: Install magento and mageforge module
## Usage: install-magento
## Example: ddev install-magento

# global config
MAGENTO_FOLDER="magento"
MODULE_FOLDER="src/"

npm install grunt-cli -g

# check if MODULE_FOLDER directory is empty
if [[ -d ${MODULE_FOLDER} && -n "$(ls -A "${MODULE_FOLDER}" || true)" ]]; then
	echo "${MODULE_FOLDER} directory is not empty. Skipping execution of install-magento."
	exit 0
fi

# download magento
composer create-project \
	--repository-url=https://mirror.mage-os.org/ \
	magento/project-community-edition \
	magento-temp

# Create Magento Folder if not exist
if [[ ! -d ${MAGENTO_FOLDER} ]]; then
	mkdir -p "${MAGENTO_FOLDER}"
fi

# copy everything from magento-temp into magento folder
cp -r magento-temp/* "${MAGENTO_FOLDER}"

# remove magento-temp
rm -rf magento-temp

# change to magento directory
cd "${MAGENTO_FOLDER}" || exit 1

# Remove *.sample extension
find . -name "*.sample" -type f -exec sh -c 'mv "$1" "${1%.sample}"' _ {} \;
rm package-lock.json # remove basic package-lock.json to avoid conflicts

# create missing local-themes.js file for grunt tasks
echo 'module.exports = {};' >dev/tools/grunt/configs/local-themes.js

# install magento
bin/magento setup:install \
	--admin-email=admin@mageforge.ddev.site \
	--admin-firstname=Mage \
	--admin-lastname=Forge \
	--admin-password=admin123 \
	--admin-user=admin \
	--backend-frontname=admin \
	--db-host=db \
	--db-name=db \
	--db-password=db \
	--db-user=db \
	--search-engine=opensearch \
	--opensearch-host=opensearch \
	--opensearch-port=9200 \
	--base-url=https://mageforge.ddev.site/ \
	--language=en_US

# install sample data
bin/magento sampledata:deploy

# add repository
composer config repositories.mageforge vcs https://github.com/OpenForgeProject/mageforge.git

# require module
composer require openforgeproject/mageforge:dev-main --prefer-source

# enable module
bin/magento setup:upgrade
