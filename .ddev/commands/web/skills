#!/usr/bin/env bash
#ddev-generated

## Description: Install or update required skills for MageForge
## Usage: skills
## Example: "ddev skills"

set -uo pipefail

# Determine directory where this script is located (symlink-safe)
SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)

# Use $DDEV_APPROOT if available (standard in DDEV), otherwise fallback to /var/www/html
PROJECT_ROOT="${DDEV_APPROOT:-/var/www/html}"
CONFIG_FILE="${PROJECT_ROOT}/.ddev/.env.skills"

# Load config
if [[ ! -f "${CONFIG_FILE}" ]]; then
    echo "❌ .env.skills file not found at ${CONFIG_FILE}"
    exit 1
fi

SKILLS_CONFIG=$(cat "${CONFIG_FILE}")

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "\n${GREEN}OpenForgeProject - Skills Manager${NC}"
echo ""

# Suppress npm warnings
export NPM_CONFIG_LOGLEVEL=error

# Determine skills directory location
POSSIBLE_DIRS=(
    "${SCRIPT_DIR}/../../.agents/skills"
    "${PROJECT_ROOT}/.agents/skills"
    "${PWD}/.agents/skills"
)

AGENTS_SKILLS_DIR=""
for dir in "${POSSIBLE_DIRS[@]}"; do
    if [[ -d "$dir" ]]; then
        AGENTS_SKILLS_DIR="$dir"
        break
    fi
done

# Collect installed skills into an associative array for O(1) lookup
declare -A INSTALLED_SKILLS_MAP

if [[ -n "$AGENTS_SKILLS_DIR" ]]; then
    shopt -s nullglob
    for skill_path in "$AGENTS_SKILLS_DIR"/*/; do
        skill_name=$(basename "$skill_path")
        INSTALLED_SKILLS_MAP["$skill_name"]=1
    done
    shopt -u nullglob
fi

# Initialize counters
UPDATED_COUNT=0
INSTALLED_COUNT=0
REMOVED_COUNT=0
FAILED_COUNT=0
declare -A CONFIGURED_SKILLS_MAP

# Process each line from config file
# Use a temp file to avoid subshell issues with herestring and IFS splitting on '='
while IFS= read -r line; do
    # Skip empty lines and comments
    [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue

    # Split only on the first '=' to handle URLs with '=' in them
    skill_name="${line%%=*}"
    repo_url="${line#*=}"

    # Remove quotes and whitespace
    skill_name=$(echo "$skill_name" | tr -d '"' | xargs)
    repo_url=$(echo "$repo_url" | tr -d '"' | xargs)

    [[ -z "$skill_name" || -z "$repo_url" ]] && continue

    # Add to configured map
    CONFIGURED_SKILLS_MAP["$skill_name"]=1

    if [[ -n "${INSTALLED_SKILLS_MAP[$skill_name]+_}" ]]; then
        echo -ne "${YELLOW}Updating: ${CYAN}$skill_name${NC} "
        update_output=$(timeout 60 npx --yes skills update --skill "$skill_name" -y </dev/null 2>&1)
        update_exit=$?
        if [[ $update_exit -eq 0 ]]; then
            echo -e "${GREEN}✓${NC}"
            ((UPDATED_COUNT++))
        else
            echo -e "${RED}✗ (timeout or error)${NC}"
            echo -e "  ${RED}↳ ${update_output}${NC}"
            ((FAILED_COUNT++))
        fi
    else
        echo -ne "${BLUE}Installing: ${CYAN}$skill_name${NC} "
        install_output=$(timeout 60 npx --yes skills add "$repo_url" --skill "$skill_name" -y </dev/null 2>&1)
        install_exit=$?
        if [[ $install_exit -eq 0 ]] && echo "$install_output" | grep -q "Done!"; then
            echo -e "${GREEN}✓${NC}"
            ((INSTALLED_COUNT++))
        else
            echo -e "${RED}✗ (timeout or error)${NC}"
            echo -e "  ${RED}↳ ${install_output}${NC}"
            ((FAILED_COUNT++))
        fi
    fi
done <<< "$SKILLS_CONFIG"

# Check for removed skills (skills installed but no longer in config)
for installed in "${!INSTALLED_SKILLS_MAP[@]}"; do
    if [[ -z "${CONFIGURED_SKILLS_MAP[$installed]+_}" ]]; then
        echo -ne "${RED}Removing: $installed${NC} "
        remove_output=$(timeout 60 npx --yes skills remove "$installed" -y </dev/null 2>&1)
        remove_exit=$?
        if [[ $remove_exit -eq 0 ]]; then
            echo -e "${GREEN}✓${NC}"
            ((REMOVED_COUNT++))
        else
            echo -e "${RED}✗ (timeout or error)${NC}"
            echo -e "  ${RED}↳ ${remove_output}${NC}"
            ((FAILED_COUNT++))
        fi
    fi
done

echo ""
echo -e "${GREEN}Summary:${NC}\n"
echo -e "  - Installed: ${GREEN}${INSTALLED_COUNT}${NC}"
echo -e "  - Updated:   ${YELLOW}${UPDATED_COUNT}${NC}"
echo -e "  - Removed:   ${RED}${REMOVED_COUNT}${NC}"
echo -e "  - Failed:    ${RED}${FAILED_COUNT}${NC}"

if [[ $FAILED_COUNT -gt 0 ]]; then
    echo -e "\n${RED}✗ ${FAILED_COUNT} skill(s) failed. Check output above for details.${NC}"
    exit 1
else
    echo -e "\n${GREEN}✓ Done!${NC}\n"
fi
