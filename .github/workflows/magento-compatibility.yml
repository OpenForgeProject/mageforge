name: Magento Modul Kompatibilitätstest

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Magento ${{ matrix.magento-version }} mit PHP ${{ matrix.php-version }} Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        magento-version: ['2.4.5', '2.4.6', '2.4.7']
        php-version: ['8.3']

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: magento
          MYSQL_DATABASE: magento
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Code auschecken
      uses: actions/checkout@v3
      with:
        path: mageforge

    - name: PHP einrichten
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, intl, gd, xml, soap, zip, bcmath, pdo_mysql, curl, sockets
        tools: composer:v2

    - name: Composer-Pakete cachen
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: ~/.composer/cache/files
        key: ${{ runner.os }}-composer-${{ matrix.magento-version }}-${{ hashFiles('**/composer.json') }}
        restore-keys: ${{ runner.os }}-composer-${{ matrix.magento-version }}

    - name: Magento klonen
      run: |
        git clone --depth=1 --branch=${{ matrix.magento-version }}-p2 https://github.com/magento/magento2.git magento2

    - name: Magento installieren
      working-directory: magento2
      env:
        COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
      run: |
        composer config minimum-stability dev
        composer config prefer-stable true
        composer install --no-interaction --no-progress
        mkdir -p app/code/OpenForgeProject
        cp -R ../mageforge app/code/OpenForgeProject/MageForge
        bin/magento setup:install \
          --base-url=http://localhost \
          --db-host=127.0.0.1 \
          --db-name=magento \
          --db-user=root \
          --db-password=magento \
          --admin-firstname=Admin \
          --admin-lastname=User \
          --admin-email=admin@example.com \
          --admin-user=admin \
          --admin-password=admin12345 \
          --language=en_US \
          --currency=USD \
          --timezone=Europe/Berlin \
          --use-rewrites=1 \
          --backend-frontname=admin \
          --cleanup-database

    - name: MageForge Modul aktivieren
      working-directory: magento2
      run: |
        bin/magento module:enable OpenForgeProject_MageForge
        bin/magento setup:upgrade

    - name: Modul-Befehle überprüfen
      working-directory: magento2
      run: |
        echo "Überprüfe, ob Modul aktiviert ist:"
        bin/magento module:status | grep OpenForgeProject_MageForge

        echo "Überprüfe, ob MageForge-Befehle verfügbar sind:"
        bin/magento list | grep mageforge

        echo "Teste MageForge Version-Befehl:"
        bin/magento mageforge:version

        echo "Teste MageForge System-Check-Befehl:"
        bin/magento mageforge:system:check

        echo "Teste MageForge Theme-List-Befehl:"
        bin/magento mageforge:theme:list

    - name: Test-Zusammenfassung
      run: |
        echo "MageForge Modul-Kompatibilitätstest mit Magento ${{ matrix.magento-version }} abgeschlossen"
