name: Magento Compatibility Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-opensearch-247:
    name: Magento ${{ matrix.magento-version }} with PHP ${{ matrix.php-version }} (OpenSearch) Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - magento-version: "2.4.7"
            php-version: "8.3"
            search-engine-name: "opensearch"
          - magento-version: "2.4.7-p8"
            php-version: "8.3"
            search-engine-name: "opensearch"

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: magento
          MYSQL_DATABASE: magento
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      elasticsearch:
        image: elasticsearch:7.17.25
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        ports:
          - 9200:9200
        options: --health-cmd="curl -s http://localhost:9200/_cluster/health" --health-interval=10s --health-timeout=5s --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          path: mageforge

      - name: Setup PHP
        uses: shivammathur/setup-php@9e72090525849c5e82e596468b86eb55e9cc5401
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, intl, gd, xml, soap, zip, bcmath, pdo_mysql, curl, sockets
          tools: composer:v2

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-composer-${{ matrix.magento-version }}-${{ hashFiles('**/composer.json') }}
          restore-keys: ${{ runner.os }}-composer-${{ matrix.magento-version }}

      - name: Clone Magento
        run: |
          git clone --depth=1 --branch=${{ matrix.magento-version }} https://github.com/magento/magento2.git magento2

      - name: Check Search Engine status
        run: |
          curl -s http://localhost:9200/_cluster/health

      - name: Install Magento
        working-directory: magento2
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          composer config minimum-stability stable
          composer config prefer-stable true
          composer install --no-interaction --no-progress
          bin/magento setup:install \
            --base-url=http://localhost \
            --db-host=127.0.0.1 \
            --db-name=magento \
            --db-user=root \
            --db-password=magento \
            --admin-firstname=Admin \
            --admin-lastname=User \
            --admin-email=admin@example.com \
            --admin-user=admin \
            --admin-password=admin12345 \
            --language=en_US \
            --currency=USD \
            --timezone=Europe/Berlin \
            --use-rewrites=1 \
            --backend-frontname=admin \
            --search-engine=${{ matrix.search-engine-name }} \
            --opensearch-host=localhost \
            --opensearch-port=9200 \
            --opensearch-index-prefix=magento \
            --cleanup-database

      - name: Install MageForge Module from current commit
        working-directory: magento2
        run: |
          # Add a local repository pointing to the current code
          composer config repositories.mageforge-local path ../mageforge

          # Install the module from the local repository
          composer require --no-update openforgeproject/mageforge:@dev

          # Update dependencies
          composer update openforgeproject/mageforge --with-dependencies

          # Enable the module and run setup upgrade
          bin/magento module:enable OpenForgeProject_MageForge
          bin/magento setup:upgrade

      - name: Check Module Commands
        working-directory: magento2
        run: |
          echo "Check if module is enabled:"
          bin/magento module:status | grep OpenForgeProject_MageForge

          echo "Check if MageForge commands are registered:"
          bin/magento list | grep mageforge

          echo "Verify all commands have --help available:"
          bin/magento mageforge:system:version --help
          bin/magento mageforge:system:check --help
          bin/magento mageforge:theme:list --help
          bin/magento mageforge:theme:build --help
          bin/magento mageforge:theme:watch --help
          bin/magento mageforge:theme:clean --help
          bin/magento mageforge:theme:inspector --help
          bin/magento mageforge:hyva:compatibility:check --help
          bin/magento mageforge:hyva:tokens --help
          bin/magento mageforge:theme:copy-from-vendor --help

          echo "Verify command aliases work:"
          bin/magento frontend:list --help
          bin/magento frontend:build --help
          bin/magento frontend:watch --help
          bin/magento frontend:clean --help
          bin/magento theme:copy --help
          bin/magento hyva:check --help
          bin/magento hyva:tokens --help

      - name: Test Copy Command Functionality
        working-directory: magento2
        run: |
          echo "Finding available test files..."
          
          # Find a frontend template file from any core module
          FRONTEND_FILE=$(find vendor/magento/module-*/view/frontend/templates -type f -name "*.phtml" 2>/dev/null | head -1)
          if [ -z "$FRONTEND_FILE" ]; then
            echo "No frontend template files found, trying layout files..."
            FRONTEND_FILE=$(find vendor/magento/module-*/view/frontend/layout -type f -name "*.xml" 2>/dev/null | head -1)
          fi
          
          # Find a base template file
          BASE_FILE=$(find vendor/magento/module-*/view/base/templates -type f -name "*.phtml" 2>/dev/null | head -1)
          if [ -z "$BASE_FILE" ]; then
            echo "No base template files found, trying web files..."
            BASE_FILE=$(find vendor/magento/module-*/view/base/web -type f \( -name "*.js" -o -name "*.css" \) 2>/dev/null | head -1)
          fi
          
          # Find an etc file for negative test
          ETC_FILE=$(find vendor/magento/module-catalog/etc -type f -name "*.xml" 2>/dev/null | head -1)
          
          echo "Test files found:"
          echo "Frontend: $FRONTEND_FILE"
          echo "Base: $BASE_FILE"
          echo "Etc: $ETC_FILE"
          echo ""
          
          if [ -n "$FRONTEND_FILE" ]; then
            echo "Test 1: Copy frontend file to frontend theme (dry-run):"
            bin/magento mageforge:theme:copy-from-vendor \
              "$FRONTEND_FILE" \
              Magento/luma \
              --dry-run
            echo "✓ Frontend to frontend mapping works"
            echo ""
          else
            echo "Warning: No frontend file found for testing"
          fi
          
          if [ -n "$BASE_FILE" ]; then
            echo "Test 2: Copy base file to frontend theme (dry-run):"
            bin/magento mageforge:theme:copy-from-vendor \
              "$BASE_FILE" \
              Magento/blank \
              --dry-run
            echo "✓ Base to frontend mapping works"
            echo ""
          else
            echo "Warning: No base file found for testing"
          fi
          
          if [ -n "$ETC_FILE" ]; then
            echo "Test 3: Verify non-view file is rejected:"
            if bin/magento mageforge:theme:copy-from-vendor \
              "$ETC_FILE" \
              Magento/luma \
              --dry-run 2>&1 | grep -q "not under a view"; then
              echo "✓ Non-view file correctly rejected"
            else
              echo "✗ Non-view file validation failed"
              exit 1
            fi
            echo ""
          else
            echo "Warning: No etc file found for negative testing"
          fi
          
          if [ -n "$FRONTEND_FILE" ]; then
            echo "Test 4: Verify cross-area mapping is rejected (frontend -> adminhtml):"
            if bin/magento mageforge:theme:copy-from-vendor \
              "$FRONTEND_FILE" \
              Magento/backend \
              --dry-run 2>&1 | grep -q "Cannot map file from area"; then
              echo "✓ Cross-area mapping correctly rejected"
            else
              echo "✗ Cross-area validation failed"
              exit 1
            fi
            echo ""
          else
            echo "Warning: No frontend file found for cross-area testing"
          fi
          
          echo "✓ All copy command tests passed!"

      - name: Test Summary
        run: |
          echo "MageForge module compatibility test with Magento ${{ matrix.magento-version }} completed"

  test-opensearch:
    name: Magento 2.4.8 with PHP 8.4 Test
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: magento
          MYSQL_DATABASE: magento
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      opensearch:
        image: opensearchproject/opensearch:2.11.0
        ports:
          - 9200:9200
        env:
          discovery.type: single-node
          plugins.security.disabled: true
          OPENSEARCH_JAVA_OPTS: -Xms512m -Xmx512m
        options: --health-cmd="curl http://localhost:9200/_cluster/health" --health-interval=10s --health-timeout=5s --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          path: mageforge

      - name: Setup PHP
        uses: shivammathur/setup-php@9e72090525849c5e82e596468b86eb55e9cc5401
        with:
          php-version: "8.4"
          extensions: mbstring, intl, gd, xml, soap, zip, bcmath, pdo_mysql, curl, sockets
          tools: composer:v2

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-composer-2.4.8-${{ hashFiles('**/composer.json') }}
          restore-keys: ${{ runner.os }}-composer-2.4.8

      - name: Clone Magento
        run: |
          git clone --depth=1 --branch=2.4.8 https://github.com/magento/magento2.git magento2

      - name: Check Search Engine status
        run: |
          curl -s http://localhost:9200/_cluster/health

      - name: Install Magento
        working-directory: magento2
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          composer config minimum-stability stable
          composer config prefer-stable true
          composer install --no-interaction --no-progress
          bin/magento setup:install \
            --base-url=http://localhost \
            --db-host=127.0.0.1 \
            --db-name=magento \
            --db-user=root \
            --db-password=magento \
            --admin-firstname=Admin \
            --admin-lastname=User \
            --admin-email=admin@example.com \
            --admin-user=admin \
            --admin-password=admin12345 \
            --language=en_US \
            --currency=USD \
            --timezone=Europe/Berlin \
            --use-rewrites=1 \
            --backend-frontname=admin \
            --search-engine=opensearch \
            --opensearch-host=localhost \
            --opensearch-port=9200 \
            --opensearch-index-prefix=magento \
            --cleanup-database

      - name: Install MageForge Module from current commit
        working-directory: magento2
        run: |
          # Add a local repository pointing to the current code
          composer config repositories.mageforge-local path ../mageforge

          # Install the module from the local repository
          composer require --no-update openforgeproject/mageforge:@dev

          # Update dependencies
          composer update openforgeproject/mageforge --with-dependencies

          # Enable the module and run setup upgrade
          bin/magento module:enable OpenForgeProject_MageForge
          bin/magento setup:upgrade

      - name: Check Module Commands
        working-directory: magento2
        run: |
          echo "Check if module is enabled:"
          bin/magento module:status | grep OpenForgeProject_MageForge

          echo "Check if MageForge commands are registered:"
          bin/magento list | grep mageforge

          echo "Verify all commands have --help available:"
          bin/magento mageforge:system:version --help
          bin/magento mageforge:system:check --help
          bin/magento mageforge:theme:list --help
          bin/magento mageforge:theme:build --help
          bin/magento mageforge:theme:watch --help
          bin/magento mageforge:theme:clean --help
          bin/magento mageforge:theme:inspector --help
          bin/magento mageforge:hyva:compatibility:check --help
          bin/magento mageforge:hyva:tokens --help
          bin/magento mageforge:theme:copy-from-vendor --help

          echo "Verify command aliases work:"
          bin/magento frontend:list --help
          bin/magento frontend:build --help
          bin/magento frontend:watch --help
          bin/magento frontend:clean --help
          bin/magento theme:copy --help
          bin/magento hyva:check --help
          bin/magento hyva:tokens --help

      - name: Test Copy Command Functionality
        working-directory: magento2
        run: |
          echo "Finding available test files..."
          
          # Find a frontend template file from any core module
          FRONTEND_FILE=$(find vendor/magento/module-*/view/frontend/templates -type f -name "*.phtml" 2>/dev/null | head -1)
          if [ -z "$FRONTEND_FILE" ]; then
            echo "No frontend template files found, trying layout files..."
            FRONTEND_FILE=$(find vendor/magento/module-*/view/frontend/layout -type f -name "*.xml" 2>/dev/null | head -1)
          fi
          
          # Find a base template file
          BASE_FILE=$(find vendor/magento/module-*/view/base/templates -type f -name "*.phtml" 2>/dev/null | head -1)
          if [ -z "$BASE_FILE" ]; then
            echo "No base template files found, trying web files..."
            BASE_FILE=$(find vendor/magento/module-*/view/base/web -type f \( -name "*.js" -o -name "*.css" \) 2>/dev/null | head -1)
          fi
          
          # Find an etc file for negative test
          ETC_FILE=$(find vendor/magento/module-catalog/etc -type f -name "*.xml" 2>/dev/null | head -1)
          
          echo "Test files found:"
          echo "Frontend: $FRONTEND_FILE"
          echo "Base: $BASE_FILE"
          echo "Etc: $ETC_FILE"
          echo ""
          
          if [ -n "$FRONTEND_FILE" ]; then
            echo "Test 1: Copy frontend file to frontend theme (dry-run):"
            bin/magento mageforge:theme:copy-from-vendor \
              "$FRONTEND_FILE" \
              Magento/luma \
              --dry-run
            echo "✓ Frontend to frontend mapping works"
            echo ""
          else
            echo "Warning: No frontend file found for testing"
          fi
          
          if [ -n "$BASE_FILE" ]; then
            echo "Test 2: Copy base file to frontend theme (dry-run):"
            bin/magento mageforge:theme:copy-from-vendor \
              "$BASE_FILE" \
              Magento/blank \
              --dry-run
            echo "✓ Base to frontend mapping works"
            echo ""
          else
            echo "Warning: No base file found for testing"
          fi
          
          if [ -n "$ETC_FILE" ]; then
            echo "Test 3: Verify non-view file is rejected:"
            if bin/magento mageforge:theme:copy-from-vendor \
              "$ETC_FILE" \
              Magento/luma \
              --dry-run 2>&1 | grep -q "not under a view"; then
              echo "✓ Non-view file correctly rejected"
            else
              echo "✗ Non-view file validation failed"
              exit 1
            fi
            echo ""
          else
            echo "Warning: No etc file found for negative testing"
          fi
          
          if [ -n "$FRONTEND_FILE" ]; then
            echo "Test 4: Verify cross-area mapping is rejected (frontend -> adminhtml):"
            if bin/magento mageforge:theme:copy-from-vendor \
              "$FRONTEND_FILE" \
              Magento/backend \
              --dry-run 2>&1 | grep -q "Cannot map file from area"; then
              echo "✓ Cross-area mapping correctly rejected"
            else
              echo "✗ Cross-area validation failed"
              exit 1
            fi
            echo ""
          else
            echo "Warning: No frontend file found for cross-area testing"
          fi
          
          echo "✓ All copy command tests passed!"

      - name: Test Summary
        run: |
          echo "MageForge module compatibility test with Magento 2.4.8 completed"
