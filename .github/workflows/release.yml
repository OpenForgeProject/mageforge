name: Create Release

on:
  push:
    tags:
      - "v*.*.*"
      - "[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          # Remove 'v' prefix if present
          VERSION=${TAG#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Extract changelog section for this version
          CHANGELOG=$(awk -v version="$VERSION" '
            BEGIN { found=0; capture=0; content="" }
            /^### \[/ {
              if (capture) { exit }
              if ($0 ~ "\\[" version "\\]") {
                found=1
                capture=1
                next
              }
            }
            capture && /^### \[/ { exit }
            capture {
              if (content != "") content = content "\n"
              content = content $0
            }
            END {
              if (found) print content
              else print "Release " version
            }
          ' CHANGELOG.md)

          # Save to file for multiline output
          echo "$CHANGELOG" > /tmp/changelog.txt

          # Set output using file
          {
            echo "content<<EOF"
            cat /tmp/changelog.txt
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.content }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
